<!DOCTYPE html>

<script type="text/javascript">
  Homey.setTitle("Create dingz-Devices");

  Homey.emit("validate", (error, result) => {
    if (error) {
      Homey.hideLoadingOverlay();
      Homey.alert(error);
    } else {
      Homey.emit("getDevicesConfig", null, (error, devicesConfig) => {
        if (error) {
          Homey.hideLoadingOverlay();
          Homey.alert(error);
        } else {
          devicesConfig.forEach((deviceConfig) => {
            Homey.emit("getDeviceManifest", deviceConfig, (error, manifest) => {
              if (error) {
                Homey.hideLoadingOverlay();
                Homey.alert(error);
              } else {
                Homey.createDevice(manifest, (error, result) => {
                  if (error) {
                    Homey.hideLoadingOverlay();
                    if (error.message.match("[duplicate_device]")) {
                      error = Error(`dingz deviceConfig (${manifest.name}) allready paired`);
                    }
                    Homey.alert(error);
                  }
                });
              }
            });
          });
          setTimeout(() => {
            Homey.done();
          }, 6000);
        }
      });
      Homey.hideLoadingOverlay();
    }
  });
</script>
